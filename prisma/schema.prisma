// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AccountRole {
  seller
  admin
}

enum PlanType {
  free
  pro
  enterprise
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
  paused
}

model Account {
  id                 String      @id @default(cuid())
  name               String      @db.VarChar(100)
  email              String      @unique @db.VarChar(100)
  password           String
  salt               String
  role               AccountRole @default(seller)
  plan_type          PlanType    @default(free)
  two_factor_enabled Boolean     @default(false)
  two_factor_secret  String?     @db.VarChar(100)
  last_login_at      DateTime?   @db.Timestamptz()
  createdAt          DateTime    @default(now()) @db.Timestamptz()
  updatedAt          DateTime    @updatedAt @db.Timestamptz()

  password_reset_tokens Password_reset_token[]
  subscriptions         Subscription[]
  usage_records         Usage_record[]
  products              Product[]
  customers             Customer[]
  orders                Order[]
  store_stocks          Store_stock[]

  @@index([email(sort: Asc)], name: "idx_accounts_email")
  @@index([role], name: "idx_accounts_role")
  @@index([plan_type], name: "idx_accounts_plan")
  @@map("accounts")
}

model Password_reset_token {
  id         Int       @id @default(autoincrement())
  account_id String
  token      String    @db.VarChar(255)
  expires_at DateTime  @db.Timestamptz()
  used_at    DateTime? @db.Timestamptz()
  createdAt  DateTime  @default(now()) @db.Timestamptz()

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([token], name: "idx_password_reset_token")
  @@index([account_id], name: "idx_password_reset_account")
  @@map("password_reset_tokens")
}

model Customer {
  id        String   @id @default(cuid())
  seller_id String
  seller    Account  @relation(fields: [seller_id], references: [id], onDelete: Cascade)
  name      String   @db.VarChar(100)
  email     String?  @db.VarChar(100)
  phone     String   @db.VarChar(15)
  document  String?  @db.VarChar(20)
  address   Json     @default("{}") @db.JsonB()
  city      String   @db.VarChar(100)
  state     String   @db.VarChar(2)
  zip_code  String?  @db.VarChar(10)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()
  Order     Order[]

  @@unique([seller_id, email])
  @@unique([seller_id, phone])
  @@unique([seller_id, document])
  @@index([seller_id], name: "idx_customers_seller")
  @@index([address], type: Gin, name: "idx_customers_address_gin")
  @@map("customers")
}

model Product {
  id             Int              @id @default(autoincrement())
  seller_id      String
  seller         Account          @relation(fields: [seller_id], references: [id], onDelete: Cascade)
  name           String           @db.VarChar(100)
  description    String?
  sku            String?          @db.VarChar(50)
  category       String?          @db.VarChar(100)
  brand          String?          @db.VarChar(100)
  unit           String           @default("un") @db.VarChar(20)
  specifications Json             @default("{}") @db.JsonB()
  images         String[]         @default([])
  active         Boolean          @default(true)
  createdAt      DateTime         @default(now()) @db.Timestamptz()
  updatedAt      DateTime         @updatedAt @db.Timestamptz()
  deletedAt      DateTime?        @db.Timestamptz()
  Order_item     Order_item[]
  Stock_movement Stock_movement[]
  prices         Product_price[]
  stock          Store_stock?

  @@unique([seller_id, sku])
  @@index([seller_id], name: "idx_products_seller")
  @@index([specifications], type: Gin, name: "idx_products_specifications_gin")
  @@index([category], name: "idx_products_category")
  @@map("products")
}

enum PriceType {
  cost
  sale
  wholesale
  promotional
}

model Product_price {
  id         Int       @id @default(autoincrement())
  product_id Int
  product    Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  price      Int
  price_type PriceType @default(sale)
  valid_from DateTime?
  valid_to   DateTime?
  active     Boolean   @default(true)
  createdAt  DateTime  @default(now()) @db.Timestamptz()
  updatedAt  DateTime  @updatedAt @db.Timestamptz()

  @@index([product_id], name: "idx_product_prices_product")
  @@map("product_prices")
}

model Store_stock {
  id                Int      @id @default(autoincrement())
  seller_id         String
  seller            Account  @relation(fields: [seller_id], references: [id], onDelete: Cascade)
  product_id        Int      @unique
  product           Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  quantity          Int      @default(0)
  reserved_quantity Int      @default(0)
  min_stock         Int      @default(0)
  max_stock         Int      @default(0)
  createdAt         DateTime @default(now()) @db.Timestamptz()
  updatedAt         DateTime @updatedAt @db.Timestamptz()

  @@index([seller_id], name: "idx_store_stock_seller")
  @@map("store_stock")
}

enum OrderStatus {
  pending
  confirmed
  shipping
  delivered
  canceled
}

enum PaymentMethod {
  cash
  credit_card
  debit_card
  pix
}

enum PaymentStatus {
  pending
  confirmed
  canceled
}

model Order {
  id             Int           @id @default(autoincrement())
  seller_id      String
  seller         Account       @relation(fields: [seller_id], references: [id], onDelete: Cascade)
  order_number   String        @db.VarChar(50)
  customer_id    String
  customer       Customer      @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  status         OrderStatus   @default(pending)
  payment_status PaymentStatus @default(pending)
  payment_method PaymentMethod @default(cash)
  delivery_date  DateTime?
  subtotal       Int           @default(0)
  discount       Int           @default(0)
  tax            Int           @default(0)
  shipping       Int           @default(0)
  total          Int           @default(0)
  notes          String?
  metadata       Json?         @db.JsonB()

  createdAt  DateTime     @default(now()) @db.Timestamptz()
  updatedAt  DateTime     @updatedAt @db.Timestamptz()
  Order_item Order_item[]
  Billing    Billing[]

  @@unique([seller_id, order_number])
  @@index([seller_id], name: "idx_orders_seller")
  @@index([seller_id, createdAt], name: "idx_orders_seller_date")
  @@map("orders")
}

model Order_item {
  id         Int     @id @default(autoincrement())
  order_id   Int
  order      Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product_id Int
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  quantity   Int     @default(1)
  unit_price Int
  discount   Int     @default(0)
  total      Int     @default(0)

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  @@index([order_id], name: "idx_order_items_order_id")
  @@index([product_id], name: "idx_order_items_product_id")
  @@map("order_items")
}

enum BillingStatus {
  pending
  partial
  paid
  overdue
  canceled
}

model Billing {
  id             Int           @id @default(autoincrement())
  order_id       Int
  order          Order         @relation(fields: [order_id], references: [id], onDelete: Cascade)
  billing_number String        @unique @db.VarChar(50)
  status         BillingStatus @default(pending)
  total_amount   Int           @default(0)
  paid_amount    Int           @default(0)
  payment_method PaymentMethod @default(cash)
  payment_status PaymentStatus @default(pending)
  due_date       DateTime      @default(now()) @db.Timestamptz()
  payment_date   DateTime?
  notes          String?

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  @@index([order_id], name: "idx_billings_order_id")
  @@map("billings")
}

enum MovementType {
  in
  out
}

enum ReferenceType {
  purchase
  sale
  adjustment
  return
  transfer
}

model Stock_movement {
  id             Int           @id @default(autoincrement())
  movement_type  MovementType
  reference_type ReferenceType
  reference_id   Int
  product_id     Int
  product        Product       @relation(fields: [product_id], references: [id], onDelete: Cascade)
  quantity       Int
  createdAt      DateTime      @default(now()) @db.Timestamptz()
  updatedAt      DateTime      @updatedAt @db.Timestamptz()

  @@index([product_id], name: "idx_stock_movements_product_id")
  @@map("stock_movements")
}

model Audit_log {
  id         Int      @id @default(autoincrement())
  action     String   @db.VarChar(50)
  entity     String   @db.VarChar(100)
  entity_id  String?  @db.VarChar(100)
  user_id    String?  @db.VarChar(100)
  old_value  Json?    @db.JsonB()
  new_value  Json?    @db.JsonB()
  metadata   Json?    @db.JsonB()
  ip_address String?  @db.VarChar(45)
  user_agent String?  @db.VarChar(500)
  created_at DateTime @default(now()) @db.Timestamptz()

  @@index([entity, entity_id], name: "idx_audit_entity")
  @@index([user_id], name: "idx_audit_user")
  @@index([created_at], name: "idx_audit_created")
  @@map("audit_logs")
}

// ==================== SUBSCRIPTION SYSTEM ====================

model Subscription {
  id                       Int                @id @default(autoincrement())
  account_id               String
  account                  Account            @relation(fields: [account_id], references: [id], onDelete: Cascade)
  plan_type                PlanType
  status                   SubscriptionStatus @default(active)
  payment_provider         String?            @db.VarChar(50) // stripe, pagseguro
  provider_subscription_id String?            @db.VarChar(255)
  provider_customer_id     String?            @db.VarChar(255)
  current_period_start     DateTime           @db.Timestamptz()
  current_period_end       DateTime           @db.Timestamptz()
  cancel_at_period_end     Boolean            @default(false)
  canceled_at              DateTime?          @db.Timestamptz()
  trial_start              DateTime?          @db.Timestamptz()
  trial_end                DateTime?          @db.Timestamptz()
  metadata                 Json?              @db.JsonB()
  createdAt                DateTime           @default(now()) @db.Timestamptz()
  updatedAt                DateTime           @updatedAt @db.Timestamptz()

  @@index([account_id], name: "idx_subscriptions_account")
  @@index([provider_subscription_id], name: "idx_subscriptions_provider")
  @@index([status], name: "idx_subscriptions_status")
  @@map("subscriptions")
}

model Usage_record {
  id              Int      @id @default(autoincrement())
  account_id      String
  account         Account  @relation(fields: [account_id], references: [id], onDelete: Cascade)
  period_start    DateTime @db.Timestamptz()
  period_end      DateTime @db.Timestamptz()
  products_count  Int      @default(0)
  orders_count    Int      @default(0)
  customers_count Int      @default(0)
  createdAt       DateTime @default(now()) @db.Timestamptz()
  updatedAt       DateTime @updatedAt @db.Timestamptz()

  @@unique([account_id, period_start])
  @@index([account_id], name: "idx_usage_records_account")
  @@index([period_start, period_end], name: "idx_usage_records_period")
  @@map("usage_records")
}

model Webhook_event {
  id           Int       @id @default(autoincrement())
  provider     String    @db.VarChar(50) // stripe, pagseguro
  event_id     String    @unique @db.VarChar(255)
  event_type   String    @db.VarChar(100)
  payload      Json      @db.JsonB()
  processed    Boolean   @default(false)
  processed_at DateTime? @db.Timestamptz()
  error        String?
  retry_count  Int       @default(0)
  createdAt    DateTime  @default(now()) @db.Timestamptz()

  @@index([provider, event_type], name: "idx_webhook_events_provider")
  @@index([processed], name: "idx_webhook_events_processed")
  @@map("webhook_events")
}
